<html>
<template id="resale-card-template">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <style>
        :host {
            background: #FAFAFA;
            border-radius: 10px;
            display: inline-block;
            height: 100%;
            margin: 2px;
            padding: 2px;
            width: 96.3%;
        }

        :host > .component {
            border-radius: 10px;
            box-shadow: 0 8px 10px 1px rgba(0, 0, 0, 0.14),
                0 3px 14px 2px rgba(0, 0, 0, 0.12),
                0 5px 5px -3px rgba(0, 0, 0, 0.4);
            display: inline-block;
            height: 130px;
            margin: 2px;
            opacity: 0;
            padding: 2px;
            position: relative;
            vertical-align: top;
            width: 130px;
        }

        :host > .component:not(#resale-refresh):hover::after {
            color: #FC5A5D;
            content: 'description';
            cursor: pointer;
            font-family: 'Material Icons';
            font-size: 32px;
            left: 110px;
            position: absolute;
            top: -6px;
        }

        :host > .component.error {
            display: inline-flex;
        }

        :host > .component > #icon-error {
            color: #FC5A5D;
            cursor: help;
            font-size: 48px;
            margin: auto;
        }

        :host > .component > .symbol {
            color: #BFBFBF;
            left: -5px;
            position: absolute;
            top: -5px;
        }

        :host > #more-info {
            height: 300px;
            width: 100%;
        }

        /**
         * Image
         */
        :host > #resale-image {
            display: inline-flex;
        }

        :host > #resale-image > .image {
            border-radius: inherit;
            display: block;
            max-height: 100%;
            max-width: 100%;
            margin: auto;
        }

        /**
         * Desc
         */
        :host > #resale-desc {
            display: inline-flex;
            flex-flow: column nowrap;
            justify-content: center;
        }

        :host > #resale-desc > *:not(header) {
            font-size: 12px;
            padding: 4px 2px;
            text-align: center;
        }

        :host > #resale-desc > .status {
            color: #FC5A5D;
            cursor: pointer;
            font-size: 18px;
            left: 0;
            position: absolute;
            top: 104px;
        }

        :host > #resale-desc > .status.active {
            color: #B1E340;
        }

        :host > #resale-desc > .link {
            font-size: 18px;
            left: 104px;
            position: absolute;
            top: 104px;
        }

        :host > #resale-desc > .link > a {
            color: #88C7D5;
            text-decoration: none;
        }

        /**
         * Price
         */
        :host > #resale-price {
            font-size: 12px;
        }

        :host > #resale-price > .divide {
            border-bottom: 1px solid #333333;
        }

        :host > #resale-price > div {
            margin: 4px;
        }

        :host > #resale-price > div:nth-child(2) {
            margin-top: 14px;
        }

        :host > #resale-price > div > div {
            display: inline-block;
        }

        :host > #resale-price > .variable > .icon {
            width: 10%;
        }

        :host > #resale-price > .variable > .icon > i {
            font-size: 11px;
        }

        :host > #resale-price > .variable > .value {
            text-align: right;
            width: 55%;
        }

        :host > #resale-price > .variable > .label {
            font-size: 7px;
        }

        /**
         * Shipping
         */
        :host > #resale-shipping {
            display: inline-flex;
            flex-flow: column nowrap;
            font-size: 10px;
            justify-content: center;
        }

        :host > #resale-shipping > div {
            margin: 2px;
        }

        :host > #resale-shipping .label,
        :host > #resale-shipping .value {
            display: inline-block;
        }

        :host > #resale-shipping > div > .label {
            text-align: right;
            width: 50%;
        }

        :host > #resale-shipping > div > .value {
            text-align: right;
            width: 45%;
        }

        :host > #resale-shipping > .estimated-arrival {
            font-size: 12px;
            margin-top: 20px;
            text-align: center;
        }

        :host > #resale-shipping > .estimated-arrival > .min,
        :host > #resale-shipping > .estimated-arrival > .max {
            font-weight: bold;
        }

        :host > #resale-shipping > .global {
            color: #B1E340;
            left: 0;
            position: absolute;
            top: 104px;
        }

        /**
         * Profit
         */
        :host > #resale-profit {
            display: inline-flex;
            flex-flow: column nowrap;
            justify-content: center;
        }

        :host > #resale-profit > .price {
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        :host > #resale-profit > .profit-price > div {
            font-size: 10px;
            margin-bottom: 4px;
            text-align: center;
        }

        :host > #resale-profit > .profit-price > div:first-child > div {
            border-bottom: 1px solid #333333;
        }

        :host > #resale-profit > .profit-price > div > div {
            display: inline-block;
            width: 31%;
        }

        :host > #resale-profit > .profit-price > div:first-child > div {
            cursor: default;
        }

        :host > #resale-profit > .profit-price > div:not(:first-child) > div {
            cursor: help;
        }

        :host > #resale-profit > .target-price {
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        :host > #resale-profit > .price > div,
        :host > #resale-profit > .target-price > div {
            margin: 1px;
        }

        /**
         * Hotness
         */
        :host > #resale-hotness > .total {
            font-size: 12px;
            margin-top: 16px;
            text-align: center;
        }

        :host > #resale-hotness > .per-day {
            font-size: 10px;
            margin: 16px auto;
            text-align: center;
        }

        :host > #resale-hotness > .per-day > div:first-child {
            border-bottom: 1px solid #333333;
            margin: 4px 28px;
        }

        /**
         * Refresh
         */
        :host > #resale-refresh {
            align-items: center;
            display: inline-flex;
            justify-content: center;
        }

        :host > #resale-refresh > .button > i {
            cursor: pointer;
            font-size: 70px;
        }

        :host > #resale-refresh > .button > i:hover {
            opacity: .7;
        }

        :host > #resale-refresh > .last-updated {
            color: #BFBFBF;
            font-size: 7px;
            left: 21px;
            position: absolute;
            top: 2px;
        }
    </style>

    <div id="resale-image" class="component">
        <header class="symbol"><i class="material-icons">burst_mode</i></header>

        <img class="image" src="">

        <!-- More -->
        <!-- other images -->
    </div>

    <div id="resale-desc" class="component">
        <header class="symbol"><i class="material-icons">link</i></header>

        <div class="title"></div>

        <div class="link"><a href="" target="_blank"><i class="material-icons">open_in_new</i></a></div>
        <div class="status"><i class="material-icons">power_settings_new</i></div>

        <!-- Extra -->
        <!-- status (de-activate listing) -->

        <!-- More -->
        <!-- item specifics -->
    </div>

    <div id="resale-price" class="component">
        <header class="symbol"><i class="material-icons">attach_money</i></header>

        <div class="price variable">
            <div class="icon"></div>
            <div class="value"></div>
            <div class="label">Price</div>
        </div>

        <div class="tax variable">
            <div class="icon"><i class="material-icons">add</i></div>
            <div class="value"></div>
            <div class="label">Tax</div>
        </div>

        <div class="shipping variable">
            <div class="icon"><i class="material-icons">add</i></div>
            <div class="value"></div>
            <div class="label">Shipping</div>
        </div>

        <div class="divide"></div>

        <div class="total variable">
            <div class="icon"></div>
            <div class="value"></div>
            <div class="label"></div>
        </div>

        <div class="quantity variable">
            <div class="icon"><i class="material-icons">clear</i></div>
            <div class="value"></div>
            <div class="label">Quantity</div>
        </div>

        <div class="divide"></div>

        <div class="sum variable">
            <div class="icon"></div>
            <div class="value"></div>
            <div class="label"></div>
        </div>

        <!-- More -->
        <!-- reprice -->
    </div>

    <div id="resale-shipping" class="component">
        <header class="symbol"><i class="material-icons">local_shipping</i></header>

        <div class="cost">
            <div class="label">Cost</div>:
            <div class="value"></div>
        </div>
        <div class="service">
            <div class="label"></div>:
            <div class="value"></div>
        </div>
        <div class="handling-time">
            <div class="label">Handling</div>:
            <div class="value"></div>
        </div>

        <div class="estimated-arrival">
            Between <span class="min"></span> and <span class="max"></span>.
        </div>

        <div class="global"><i class="material-icons">public</i></div>

        <!-- More -->
        <!-- doesn't ship to -->
    </div>

    <div id="resale-profit" class="component">
        <header class="symbol"><i class="material-icons">monetization_on</i></header>

        <div class="price">
            <div class="label">BIN Price:</div>
            <div class="value"></div>
        </div>

        <div class="profit-price">
            <div class="head">
                <div>-10%</div>
                <div>even</div>
                <div>10%</div>
            </div>
            <div class="no-tax">
                <div title="0% tax"></div>
                <div title="0% tax"></div>
                <div title="0% tax"></div>
            </div>
            <div class="with-tax">
                <div title="8.45% tax"></div>
                <div title="8.45% tax"></div>
                <div title="8.45% tax"></div>
            </div>
        </div>

        <div class="target-price">
            <div class="label">Target Price:</div>
            <div class="value"></div>
        </div>

        <!-- Extra -->
        <!-- most sold snipe price & undercut $/% -->
        <!-- best supply price & profit $/% -->

        <!-- More -->
        <!-- eBay fee -->
        <!-- PayPal fee -->
    </div>

    <div id="resale-snipe" class="component">
        <header class="symbol"><i class="material-icons">watch</i></header>

        <!-- Extra -->
        <!-- price -->
        <!-- tax -->
        <!-- shipping -->
        <!-- total (price + tax + shipping) -->
        <!-- handling time + shipping time -->
        <!-- # sold (past n days) -->
    </div>

    <div id="resale-supply" class="component">
        <header class="symbol"><i class="material-icons">local_grocery_store</i></header>

        <!-- Extra -->
        <!-- price -->
        <!-- tax -->
        <!-- shipping -->
        <!-- shipping time -->
        <!-- # available -->
    </div>

    <div id="resale-hotness" class="component">
        <header class="symbol"><i class="material-icons">star_border</i></header>

        <div class="total">
            <span class="visits"></span> visits, <span class="watchers"></span> watchers, and <span class="sold"></span> sold since <span class="time-active"></span>.
        </div>

        <div class="per-day">
            <div>Per day:</div>
            <div class="visits">
                <span></span> visits
            </div>
            <div class="watchers">
                <span></span> watchers
            </div>
            <div class="sold">
                <span></span> sold
            </div>
        </div>

        <!-- Extra -->
        <!-- visits -->
        <!-- sold -->
        <!-- hotness meter -->
        <!-- total profit -->
        <!-- total profit / day -->
    </div>

    <div id="resale-refresh" class="component">
        <header class="symbol"><i class="material-icons">redo</i></header>

        <div class="button"><i class="material-icons">replay</i></div>

        <div class="last-updated">Last updated: <span></span></div>

        <!-- Extra -->
        <!-- freshness meter -->
    </div>

    <div id="more-info" style="display:none;"></div>

    <script src="/components/jquery/dist/jquery.min.js" defer></script>
    <script src="/components/moment/min/moment.min.js" defer></script>
</template>

<script>
    (function () {
        const currentDoc = document.currentScript.ownerDocument;

        class ResaleCard extends HTMLElement {

            constructor() {
                const template = currentDoc.querySelector('#resale-card-template');

                super();

                this.attachShadow({ mode: 'open' });
                this.shadowRoot.appendChild(template.content.cloneNode(true));
            }

            connectedCallback() {
                const resaleId = this.getAttribute('resale-id');
                const self = this;
                const storeUri = this.getAttribute('store-uri');

                fetch(`${storeUri}/resales/${resaleId}`)
                    .then((response) => response.text())
                    .then((responseText) => {
                        this.render(JSON.parse(responseText));
                    })
                    .catch((err) => {
                        // todo - make card display error (maybe attribute error)
                        console.log(err);
                    });
            }

            render(data) {
                var $components = $('.component', this.shadowRoot);
                var $more = $('#more-info', this.shadowRoot);
                var self = this;

                if (!data)
                    return $(this).hide(); // todo: handle this better

                $(this).attr('title', data.title);

                this.renderImage(data);
                this.renderDesc(data);
                this.renderPrice(data);
                this.renderShipping(data);
                this.renderProfit(data);
                this.renderSnipe(data);
                this.renderSupply(data);
                this.renderHotness(data);
                this.renderRefresh(data);

                $components.on('click', function (e) {
                    var $this = $(this);

                    if (
                        e.clientX > $this.offset().left + 110 &&
                        e.clientY > $this.offset().top - 6 &&
                        e.clientY < $this.offset().top - 6 + 32
                    ) {
                        if ($more.is(':visible'))
                            $more.slideUp('fast').delay('201').empty();

                        setTimeout(function () { // waiting ensures content isn't changed before slideUp occurs
                            self.renderMoreInfo($this.attr('id'), data);
                        }, 201);

                        $more.slideDown();
                    }
                });

                // Ease in components to prevent FOUC
                setTimeout(function() {
                    $components.each(function () {
                        $(this).animate({ opacity: 1 }, Math.random() * 500 + 200, 'swing');
                    });
                }, 500);
            }

            renderImage(data) {
                var $image = $('#resale-image', this.shadowRoot);

                try {
                    $image.find('.image').attr('src', data.images[0]);
                } catch (e) {
                    this.renderError(e, $image);
                }
            }

            renderDesc(data) {
                var $desc = $('#resale-desc', this.shadowRoot);

                try {
                    $desc.find('.title').text(data.title || 'N/a');
                    $desc.find('.link > a').attr('href', data.link);

                    if (data.state.toLowerCase() === 'active')
                        $desc.find('.status').addClass('active');
                } catch (e) {
                    this.renderError(e, $desc);
                }
            }

            renderPrice(data) {
                var $price = $('#resale-price', this.shadowRoot);

                try {
                    $price.find('.price > .value').text(`$${(+data.price).toFixed(2)}`);
                    $price.find('.tax > .value').text(`$${(+data.tax).toFixed(2)}`);
                    $price.find('.shipping > .value').text(`$${(+data.shipping.cost).toFixed(2)}`);

                    $price.find('.total > .value').text(
                        `$${(+data.price + +data.tax + +data.shipping.cost).toFixed(2)}`
                    );

                    $price.find('.quantity > .value').text(data.quantity);
                    $price.find('.sum > .value').text(
                        `$${((+data.price + +data.tax + +data.shipping.cost) * data.quantity).toFixed(2)}`
                    );
                } catch (e) {
                    this.renderError(e, $price);
                }
            }

            renderShipping(data) {
                var $ship = $('#resale-shipping', this.shadowRoot);
                var service;

                try {
                    if (data.shipping.estimatedDelivery.max === 3)
                        service = 'Expedited';
                    else
                        service = 'Standard';

                    $ship.find('.cost > .value').text(`$${(+data.shipping.cost).toFixed(2)}`);

                    $ship.find('.service > .label').text(service);
                    $ship.find('.service > .value').text(`1 to ${data.shipping.estimatedDelivery.max} days`);

                    $ship.find('.handling-time > .value').text(`${data.shipping.handlingTime} days`);

                    $ship.find('.estimated-arrival > .min').text(
                        moment().add(
                            +data.shipping.estimatedDelivery.min + +data.shipping.handlingTime,
                            'days'
                        ).format('ddd, Do')
                    );
                    $ship.find('.estimated-arrival > .max').text(
                        moment().add(
                            +data.shipping.estimatedDelivery.max + +data.shipping.handlingTime,
                            'days'
                        ).format('ddd, Do')
                    );

                    if (!!!data.shipping.isGlobal)
                        $ship.find('.global').hide();
                } catch (e) {
                    this.renderError(e, $ship);
                }
            }

            renderProfit(data) {
                var $profit = $('#resale-profit', this.shadowRoot);
                var price = data.price.toFixed(2);

                try {
                    $profit.find('.price > .value').text(`$${price}`);

                    $profit.find('.profit-price > .no-tax > div:nth-child(1)')
                        .text(`$${supplyPriceByProfitPercent(-10, 0)}`);
                    $profit.find('.profit-price > .no-tax > div:nth-child(2)')
                        .text(`$${supplyPriceByProfitPercent(0, 0)}`);
                    $profit.find('.profit-price > .no-tax > div:last-child')
                        .text(`$${supplyPriceByProfitPercent(10, 0)}`);

                    $profit.find('.profit-price > .with-tax > div:nth-child(1)')
                        .text(`$${supplyPriceByProfitPercent(-10, 8.45)}`);
                    $profit.find('.profit-price > .with-tax > div:nth-child(2)')
                        .text(`$${supplyPriceByProfitPercent(0, 8.45)}`);
                    $profit.find('.profit-price > .with-tax > div:last-child')
                        .text(`$${supplyPriceByProfitPercent(10, 8.45)}`);

                    $profit.find('.target-price > .value')
                        .text(`$${supplyPriceByProfitPercent(10, 8.45)}`);
                } catch (e) {
                    this.renderError(e, $profit);
                }

                function supplyPriceByProfitPercent(profitPercent, taxPercent) {
                    var eBayFee = price * 0.0915;
                    var payPalFee = price * 0.029 + 0.3;
                    var profit = price * (profitPercent / 100);
                    var supply;
                    var tax = 0;

                    supply = (price - eBayFee - payPalFee - profit).toFixed(2);
                    tax = supply * (taxPercent / 100);

                    return (price - eBayFee - payPalFee - profit - tax).toFixed(2);
                }
            }

            renderSnipe(data) {
                var $snipe = $('#resale-snipe', this.shadowRoot);

                try {
                } catch (e) {
                    this.renderError(e, $snipe);
                }

            }

            renderSupply(data) {
                var $supply = $('#resale-supply', this.shadowRoot);

                try {
                } catch (e) {
                    this.renderError(e, $supply);
                }

            }

            renderHotness(data) {
                var $hotness = $('#resale-hotness', this.shadowRoot);
                var daysAlive;
                var resaleDate = data.dateListed[data.dateListed.length - 1].start;

                try {
                    $hotness.find('.total > .visits').text(data.visits);
                    $hotness.find('.total > .watchers').text(data.watchers);
                    $hotness.find('.total > .sold').text(data.sold);
                    $hotness.find('.total > .time-active').text(moment(resaleDate).fromNow());

                    daysAlive = moment.duration(moment().diff(moment(resaleDate))).asDays();
                    $hotness.find('.per-day > .visits > span').text((data.visits / daysAlive).toFixed(5));
                    $hotness.find('.per-day > .watchers > span').text((data.watchers / daysAlive).toFixed(5));
                    $hotness.find('.per-day > .sold > span').text((data.sold / daysAlive).toFixed(5));
                } catch (e) {
                    this.renderError(e, $hotness);
                }
            }

            renderRefresh(data) {
                var $refresh = $('#resale-refresh', this.shadowRoot);

                try {
                    $refresh.find('.last-updated > span').text(moment(data.updatedAt).fromNow());
                } catch (e) {
                    this.renderError(e, $refresh);
                }
            }

            renderMoreInfo(section, data) {
                var $more = $('#more-info', this.shadowRoot);

                $more.text(section);
            }

            renderError(err, $component) {
                $component
                .empty()
                .addClass('error')
                .append(
                    `<i id="icon-error" class="material-icons" title="${err}">sync_problem</i>`
                );
            }

        }

        window.customElements.define('resale-card', ResaleCard);
    }());
</script>
</html>
