<html>
<template id="resale-card-template">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <style>
        :host {
            background: #FAFAFA;
            border-radius: 10px;
            display: inline-block;
            height: 100%;
            margin: 2px;
            padding: 2px;
            width: 96.3%;
        }

        :host > .component {
            border-radius: 10px;
            box-shadow: 0 8px 10px 1px rgba(0, 0, 0, 0.14),
                0 3px 14px 2px rgba(0, 0, 0, 0.12),
                0 5px 5px -3px rgba(0, 0, 0, 0.4);
            display: inline-block;
            height: 130px;
            margin: 2px;
            opacity: 0;
            padding: 2px;
            position: relative;
            vertical-align: top;
            width: 130px;
        }

        :host > .component:not(#resale-refresh):hover::after {
            color: #FC5A5D;
            content: 'description';
            cursor: pointer;
            font-family: 'Material Icons';
            font-size: 40px;
            left: 104px;
            position: absolute;
            top: -6px;
        }

        :host > #more-info {
            height: 300px;
            width: 100%;
        }

        /**
         * Image
         */
        :host > #resale-image > .image {
            border-radius: inherit;
            display: block;
            max-height: 100%;
            max-width: 100%;
            margin: auto;
        }

        /**
         * Desc
         */
        :host > #resale-desc {
            display: inline-flex;
            flex-flow: column nowrap;
            justify-content: center;
        }

        :host > #resale-desc > * {
            font-size: 12px;
            padding: 4px 2px;
            text-align: center;
        }

        :host > #resale-desc > .status {
            color: #FC5A5D;
            cursor: pointer;
            font-size: 18px;
            left: 0;
            position: absolute;
            top: 104px;
        }

        :host > #resale-desc > .status.active {
            color: #B1E340;
        }

        :host > #resale-desc > .link {
            font-size: 18px;
            left: 104px;
            position: absolute;
            top: 104px;
        }

        :host > #resale-desc > .link > a {
            color: #88C7D5;
            text-decoration: none;
        }

        /**
         * Profit
         */
        :host > #resale-profit {
            display: inline-flex;
            flex-flow: column nowrap;
            justify-content: space-around;
        }

        :host > #resale-profit > * {
            font-size: 11px;
            text-align: left;
        }

        /**
         * Hotness
         */
        :host > #resale-hotness {
            display: inline-flex;
            flex-flow: column nowrap;
            justify-content: space-evenly;
        }

        :host > #resale-hotness > * {
            font-size: 11px;
            text-align: left;
        }

        /**
         * Refresh
         */
        :host > #resale-refresh {
            align-items: center;
            display: inline-flex;
            justify-content: center;
        }

        :host > #resale-refresh > i {
            cursor: pointer;
            font-size: 70px;
        }

        :host > #resale-refresh > i:hover {
            opacity: .7;
        }
    </style>

    <div id="resale-image" class="component">
        <img class="image" src="">

        <!-- More -->
        <!-- other images -->
    </div>

    <div id="resale-desc" class="component">
        <div class="title"></div>

        <div class="link"><a href="" target="_blank"><i class="material-icons">open_in_new</i></a></div>
        <div class="status"><i class="material-icons">power_settings_new</i></div>

        <!-- Extra -->
        <!-- status (de-activate listing) -->

        <!-- More -->
        <!-- item specifics -->
    </div>

    <div id="resale-price" class="component">
        <!-- Might be able to remove this one -->

        <!-- price -->
        <!-- tax -->
        <!-- shipping cost -->
        <!-- total -->
        <!-- quantity -->
        <!-- sum total -->

        <!-- More -->
        <!-- reprice -->
    </div>

    <div id="resale-shipping" class="component">
        <!-- cost -->
        <!-- service & timeframe -->
        <!-- handling time -->
        <!-- estimated arrival -->
    </div>

    <div id="resale-profit" class="component">
        <div class="price"><span class="label">BIN Price: </span><span class="value"></span></div>
        <!-- eBay fee -->
        <!-- PayPal fee -->
        <!-- total -->

        <!-- Extra -->
        <!-- snipe price -->
        <!-- supply price -->
        <!-- profit $/% -->
        <!-- undercut $/% -->
    </div>

    <div id="resale-snipe" class="component">
        Snipe

        <!-- Extra -->
        <!-- price -->
        <!-- tax -->
        <!-- shipping -->
        <!-- total (price + tax + shipping) -->
        <!-- handling time + shipping time -->
        <!-- # sold (past n days) -->
    </div>

    <div id="resale-supply" class="component">
        Supply

        <!-- Extra -->
        <!-- price -->
        <!-- tax -->
        <!-- shipping -->
        <!-- shipping time -->
        <!-- # available -->
    </div>

    <div id="resale-hotness" class="component">
        <div class="time"><span class="label">Alive: </span><span class="value"></span></div>
        <div class="watchers"><span class="label">Watchers: </span><span class="value"></span></div>

        <!-- Extra -->
        <!-- visits -->
        <!-- sold -->
        <!-- hotness meter -->
        <!-- total profit -->
        <!-- total profit / day -->
    </div>

    <div id="resale-refresh" class="component">
        <i class="material-icons">replay</i>
        <!-- last updated time -->

        <!-- Extra -->
        <!-- freshness meter -->
    </div>

    <div id="more-info" style="display:none;"></div>

    <script src="/components/jquery/dist/jquery.min.js" defer></script>
    <script src="/components/moment/min/moment.min.js" defer></script>
</template>

<script>
    (function () {
        const currentDoc = document.currentScript.ownerDocument;

        class ResaleCard extends HTMLElement {

            constructor() {
                const template = currentDoc.querySelector('#resale-card-template');

                super();

                this.attachShadow({ mode: 'open' });
                this.shadowRoot.appendChild(template.content.cloneNode(true));
            }

            connectedCallback() {
                const resaleId = this.getAttribute('resale-id');
                const self = this;
                const storeUri = this.getAttribute('store-uri');

                fetch(`${storeUri}/resales/${resaleId}`)
                    .then((response) => response.text())
                    .then((responseText) => {
                        this.render(JSON.parse(responseText));
                    })
                    .catch((err) => {
                        // todo - make card display error (maybe attribute error)
                        console.log(err);
                    });
            }

            render(data) {
                var $components = $('.component', this.shadowRoot);
                var $more = $('#more-info', this.shadowRoot);
                var self = this;

                this.renderImage(data);
                this.renderDesc(data);
                this.renderPrice(data);
                this.renderShipping(data);
                this.renderProfit(data);
                this.renderSnipe(data);
                this.renderSupply(data);
                this.renderHotness(data);
                this.renderRefresh(data);

                $components.on('click', function (e) {
                    var $this = $(this);

                    if (
                        e.clientX > $this.offset().left + 104 &&
                        e.clientY > $this.offset().top - 6 &&
                        e.clientY < $this.offset().top - 6 + 40
                    ) {
                        if ($more.is(':visible'))
                            $more.slideUp('fast').delay('201').empty();

                        setTimeout(function () { // waiting ensures content isn't changed before slideUp occurs
                            self.renderMoreInfo($this.attr('id'), data);
                        }, 201);

                        $more.slideDown();
                    }
                });

                // Ease in components to prevent FOUC
                setTimeout(function() {
                    $components.each(function () {
                        $(this).animate({ opacity: 1 }, Math.random() * 500 + 200, 'swing');
                    });
                }, 500);
            }

            renderImage(data) {
                var $image = $('#resale-image', this.shadowRoot);

                $image.find('.image').attr('src', data.images[0]);
            }

            renderDesc(data) {
                var $desc = $('#resale-desc', this.shadowRoot);

                $desc.find('.title').text(data.title || 'N/a');
                $desc.find('.link > a').attr('href', data.link);

                if (data.state.toLowerCase() === 'active')
                    $desc.find('.status').addClass('active');
            }

            renderPrice(data) {

            }

            renderShipping(data) {

            }

            renderProfit(data) {
                var $profit = $('#resale-profit', this.shadowRoot);

                $profit.find('.price > .value').text(`$${data.price.toFixed(2)}`);
                $profit.find('.snipe > .value').text(`$${data.price.toFixed(2)}`);
                $profit.find('.supply > .value').text(`$${data.price.toFixed(2)}`);
            }

            renderSnipe(data) {

            }

            renderSupply(data) {

            }

            renderHotness(data) {
                var $hotness = $('#resale-hotness', this.shadowRoot);
                var resaleDate = data.dateListed[data.dateListed.length - 1].start;

                $hotness.find('.time > .value').text(moment(resaleDate).from(moment(), true));
                $hotness.find('.visits > .value').text(data.visits);
                $hotness.find('.watchers > .value').text(data.watchers);
                $hotness.find('.sold > .value').text(data.sold);
            }

            renderRefresh(data) {

            }

            renderMoreInfo(section, data) {
                var $more = $('#more-info', this.shadowRoot);

                $more.text(section);
            }

        }

        window.customElements.define('resale-card', ResaleCard);
    }());
</script>
</html>
