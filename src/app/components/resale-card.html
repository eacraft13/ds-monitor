<html>
<template id="resale-card-template">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <!-- Styles -->
    <style>
        :host {
            background: #FAFAFA;
            border-radius: 10px;
            display: inline-block;
            height: 140px;
            margin: 2px;
            padding: 2px;
            width: 96.3%;
        }

        :host > .component {
            border-radius: 10px;
            box-shadow: 0 8px 10px 1px rgba(0, 0, 0, 0.14),
                0 3px 14px 2px rgba(0, 0, 0, 0.12),
                0 5px 5px -3px rgba(0, 0, 0, 0.4);
            display: inline-block;
            height: 130px;
            margin: 2px;
            opacity: 0;
            padding: 2px;
            vertical-align: top;
            width: 130px;
        }

        :host > #resale-image > .image {
            border-radius: inherit;
            display: block;
            max-height: 100%;
            max-width: 100%;
            margin: auto;
        }

        /**
         * Desc
         */
        :host > #resale-desc {
            display: inline-flex;
            flex-flow: column nowrap;
            justify-content: space-around;
        }

        :host > #resale-desc > * {
            text-align: center;
            font-size: 12px;
        }

        /**
         * Profit
         */
        :host > #resale-profit {
            display: inline-flex;
            flex-flow: column nowrap;
            justify-content: space-around;
        }

        :host > #resale-profit > * {
            font-size: 11px;
            text-align: left;
        }

        /**
         * Hotness
         */
        :host > #resale-hotness {
            display: inline-flex;
            flex-flow: column nowrap;
            justify-content: space-evenly;
        }

        :host > #resale-hotness > * {
            font-size: 11px;
            text-align: left;
        }

        /**
         * Refresh
         */
        :host > #resale-refresh {
            align-items: center;
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
        }

        :host > #resale-refresh:hover {
            opacity: .7;
        }

        :host > #resale-refresh > i {
            font-size: 70px;
        }

    </style>

    <!-- Content -->
    <div id="resale-image" class="component">
        <img class="image" src="">
        <!-- other images -->
    </div>
    <div id="resale-desc" class="component">
        <div class="title"></div>
        <div class="link"><a href="" target="_blank"></a></div>
        <!-- item specifics -->
        <!-- status (de-activate listing) -->
    </div>

    <div id="resale-price" class="component">
        Price
        <!-- quantity -->
        <!-- tax -->
        <!-- shipping cost -->
    </div>

    <div id="resale-shipping" class="component">
        Shipping
        <!-- shipping time/service -->
        <!-- handling time -->
    </div>

    <div id="resale-profit" class="component">
        <div class="price"><span class="label">BIN Price: </span><span class="value"></span></div>
        <div class="snipe"><span class="label">Snipe Price: </span><span class="value"></span></div>
        <div class="supply"><span class="label">Supply Price: </span><span class="value"></span></div>
        <!-- eBay fee -->
        <!-- PayPal fee -->
        <!-- profit -->
        <!-- profit % -->
        <!-- undercut $ -->
        <!-- undercut % -->
    </div>

    <div id="resale-snipe" class="component">
        Snipe
        <!-- price -->
        <!-- tax -->
        <!-- shipping -->
        <!-- total (price + tax + shipping) -->
        <!-- handling time + shipping time -->
        <!-- # sold (past n days) -->
    </div>

    <div id="resale-supply" class="component">
        Supply
        <!-- price -->
        <!-- tax -->
        <!-- shipping -->
        <!-- shipping time -->
        <!-- # available -->
    </div>

    <div id="resale-hotness" class="component">
        <div class="time"><span class="label">Alive: </span><span class="value"></span></div>
        <div class="visits"><span class="label">Visits: </span><span class="value"></span></div>
        <div class="watchers"><span class="label">Watchers: </span><span class="value"></span></div>
        <div class="sold"><span class="label">Sold: </span><span class="value"></span></div>
        <!-- hotness meter -->
        <!-- total profit -->
        <!-- total profit / day -->
    </div>

    <div id="resale-refresh" class="component">
        <i class="material-icons">replay</i>
        <!-- last updated time -->
        <!-- freshness meter -->
    </div>

    <script src="/components/jquery/dist/jquery.min.js" defer></script>
    <script src="/components/moment/min/moment.min.js" defer></script>
</template>

<!-- Scripts -->
<script>
    (function () {
        const currentDoc = document.currentScript.ownerDocument;

        class ResaleCard extends HTMLElement {

            constructor() {
                const template = currentDoc.querySelector('#resale-card-template');

                super();

                this.attachShadow({ mode: 'open' });
                this.shadowRoot.appendChild(template.content.cloneNode(true));
            }

            connectedCallback() {
                const resaleId = this.getAttribute('resale-id');
                const self = this;
                const storeUri = this.getAttribute('store-uri');

                fetch(`${storeUri}/resales/${resaleId}`)
                    .then((response) => response.text())
                    .then((responseText) => {
                        this.render(JSON.parse(responseText));
                    })
                    .catch((err) => {
                        // todo - make card display error (maybe attribute error)
                        console.log(err);
                    });
            }

            render(data) {
                var $desc = $('#resale-desc', this.shadowRoot);
                var $image = $('#resale-image', this.shadowRoot);
                var $hotness = $('#resale-hotness', this.shadowRoot);
                var $profit = $('#resale-profit', this.shadowRoot);
                var $status = $('#resale-status', this.shadowRoot);

                var resaleDate;
                var self = this;

                // image
                $image.find('.image').attr('src', data.images[0]);

                // desc
                $desc.find('.title').text(data.title || 'N/a');
                $desc.find('.link > a').attr('href', data.link);
                $desc.find('.link > a').text(data.eBayId);

                // price

                // shipping

                // profit
                $profit.find('.price > .value').text(`$${data.price.toFixed(2)}`);
                $profit.find('.snipe > .value').text(`$${data.price.toFixed(2)}`);
                $profit.find('.supply > .value').text(`$${data.price.toFixed(2)}`);

                // snipe

                // supply

                // hotness
                resaleDate = data.dateListed[data.dateListed.length - 1].start;
                $hotness.find('.time > .value').text(moment(resaleDate).from(moment(), true));
                $hotness.find('.visits > .value').text(data.visits);
                $hotness.find('.watchers > .value').text(data.watchers);
                $hotness.find('.sold > .value').text(data.sold);

                // refresh

                // Ease in components to prevent FOUC
                setTimeout(function() {
                    $('.component', self.shadowRoot).each(function () {
                        $(this).animate({ opacity: 1 }, Math.random() * 500 + 200, 'swing');
                    });
                }, 500);
            }

        }

        window.customElements.define('resale-card', ResaleCard);
    }());
</script>
</html>
